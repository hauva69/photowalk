#!/usr/bin/python

import errno
import os
import shutil
import sys

def init():
    nefdn = 'orig_nef'
    jpgdn = 'orig_jpg'
    try:
        os.mkdir(nefdn)
    except OSError, ex:
        if ex.errno == errno.EEXIST:
            pass
        else:
            raise ex
    try:
        os.mkdir(jpgdn)
    except OSError, ex:
        if ex.errno == errno.EEXIST:
            pass
        else:
            raise ex
    for i in os.listdir('.'):
        fn = i.lower()
        if fn.endswith('.nef'):
            fn = '%s/%s' % (nefdn, fn)
        elif fn.endswith('.jpg'):
            fn = '%s/%s' % (jpgdn, fn)
        shutil.move(i, fn)

def cand(jpgdn, canddn):
    '''Hard links all *.jpg files from jpgdn to canddn.'''
    try:
        os.mkdir(canddn)
    except OSError, ex:
        if ex.errno == errno.EEXIST:
            pass
        else:
            raise ex
    for i in os.listdir(jpgdn):
        fn = '%s/%s' % (jpgdn, i)
        tofn = '%s/%s' % (canddn, i)
        os.link(fn, tofn)

def rawcand(canddn, rawdn, todn):
    '''Takes all files from canddn and hard links the corresponding RAW
files from rawdn to todn.'''
    try:
        os.mkdir(todn)
    except OSError, ex:
        if errno.EEXIST == ex.errno:
            pass
        else:
            raise ex
    for i in os.listdir(canddn):
        rawfn = '%s/%s' % (rawdn, i.replace('.jpg', '.nef'))
        tmp = '%s/%s' % (todn, i.replace('.jpg', '.nef'))
        if not os.path.exists(tmp):
            os.link(rawfn, tmp)

def main():
    cmd = sys.argv[1]
    if cmd == 'init':
        init()
    elif cmd == 'cand':
        cand(sys.argv[2], sys.argv[3])
    elif cmd == 'rawcand':
        rawcand(sys.argv[2], sys.argv[3], sys.argv[4])

if __name__ == '__main__':
    main()

